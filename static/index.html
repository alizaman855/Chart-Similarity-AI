<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Analysis System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e88e5;
            --secondary: #42a5f5;
            --success: #43a047;
            --warning: #ffa000;
            --error: #e53935;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
            --muted: #757575;
            --border: #e0e0e0;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            box-shadow: var(--shadow);
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .admin-access {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .admin-btn, .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .admin-btn:hover, .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
            text-decoration: none;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--error);
            transition: background 0.3s ease;
        }

        .status-dot.available { 
            background: var(--success) !important; 
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 1200px) {
            .main-grid {
                grid-template-columns: 400px 1fr;
            }
        }

        .card {
            background: var(--card);
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            color: var(--primary);
        }

        .card-title i { margin-right: 10px; }

        .method-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .method-option {
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .method-option:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .method-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .method-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .method-option.disabled:hover {
            transform: none;
            box-shadow: none;
            background: #f5f5f5;
        }

        .method-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .method-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .method-description {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .category-option {
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-option i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        .category-option.selected {
            border-color: var(--primary);
            background: rgba(30, 136, 229, 0.05);
        }

        .drop-area {
            border: 3px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .drop-area:hover, .drop-area.active {
            border-color: var(--primary);
            background: rgba(30, 136, 229, 0.05);
        }

        .drop-area.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .drop-area i {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .file-info {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.02);
            margin-bottom: 20px;
        }

        .file-info i {
            color: var(--primary);
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .file-info .file-name {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-info .remove-file {
            color: var(--error);
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .file-info .remove-file:hover {
            background: rgba(229, 57, 53, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 136, 229, 0.3);
        }

        .btn:disabled {
            background: #cccccc !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
            opacity: 0.7 !important;
        }

        .btn i { margin-right: 8px; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group small {
            color: var(--muted);
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
            border-radius: 5px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .jobs-list {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .job-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .job-item:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateX(5px);
        }

        .job-item.active {
            background: rgba(30, 136, 229, 0.1);
            border-left: 4px solid var(--primary);
        }

        .job-info {
            flex-grow: 1;
            margin-left: 15px;
        }

        .job-filename {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .job-time {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .job-actions {
            display: flex;
        }

        .job-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--muted);
            padding: 8px;
            border-radius: 4px;
            transition: color 0.3s ease;
        }

        .job-actions button:hover {
            color: var(--primary);
            background: rgba(0, 0, 0, 0.05);
        }

        .job-actions button.delete:hover {
            color: var(--error);
        }

        .results-area {
            display: none;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 25px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .frames-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .frame-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .frame-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .frame-card.selected {
            border: 3px solid var(--primary);
        }

        .frame-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .frame-info {
            padding: 15px;
        }

        .frame-time {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .similarity-score {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .similarity-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-size: 0.8rem;
            margin-left: 8px;
            font-weight: 500;
        }

        .high-similarity { background: var(--success); }
        .medium-similarity { background: var(--warning); }
        .low-similarity { background: var(--error); }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 90%;
            max-width: 800px;
            margin-top: 5%;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover { color: #bbb; }

        .alert {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            font-weight: 500;
            border-left: 4px solid;
        }

        .alert i {
            margin-right: 12px;
            font-size: 1.2rem;
        }

        .alert-success {
            background: rgba(67, 160, 71, 0.1);
            color: var(--success);
            border-left-color: var(--success);
        }

        .alert-warning {
            background: rgba(255, 160, 0, 0.1);
            color: var(--warning);
            border-left-color: var(--warning);
        }

        .alert-error {
            background: rgba(229, 57, 53, 0.1);
            color: var(--error);
            border-left-color: var(--error);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s infinite linear;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .method-grid { grid-template-columns: 1fr; }
            .category-grid { grid-template-columns: 1fr; }
            .frames-grid { grid-template-columns: 1fr; }
            .status-bar { flex-direction: column; gap: 15px; }
            .admin-access { position: static; margin-top: 15px; justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="imageModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <div class="container">
        <div class="header">
            <div class="admin-access">
                <a href="/admin" class="admin-btn">
                    <i class="fas fa-user-shield"></i> Admin
                </a>
            </div>
            
            <h1><i class="fas fa-chart-line"></i> Chart Analysis System</h1>
            <p>Choose between Computer Vision and GPT Vision analysis methods</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="cv-status"></div>
                    <span>Computer Vision</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="gpt-status"></div>
                    <span>GPT Vision</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-database"></i>
                    <span id="historical-count">0 Historical Charts</span>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="sidebar">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-robot"></i> Analysis Method
                    </div>
                    <div class="method-grid">
                        <div class="method-option" id="cv-method" data-method="computer_vision">
                            <i class="fas fa-video method-icon"></i>
                            <div class="method-title">Computer Vision</div>
                            <div class="method-description">Frame-by-frame video analysis</div>
                        </div>
                        <div class="method-option" id="gpt-method" data-method="gpt_vision">
                            <i class="fas fa-brain method-icon"></i>
                            <div class="method-title">GPT Vision</div>
                            <div class="method-description">AI-powered image comparison</div>
                        </div>
                    </div>
                </div>

                <div class="card upload-section" id="cv-upload" style="display: none;">
                    <div class="card-title">
                        <i class="fas fa-upload"></i> Upload Video
                    </div>
                    
                    <div class="form-group">
                        <label>Market Category</label>
                        <div class="category-grid">
                            <div class="category-option" data-category="gold">
                                <i class="fas fa-coins"></i>Gold
                            </div>
                            <div class="category-option" data-category="btc">
                                <i class="fab fa-bitcoin"></i>BTC
                            </div>
                            <div class="category-option" data-category="usdcad">
                                <i class="fas fa-dollar-sign"></i>USDCAD
                            </div>
                        </div>
                    </div>
                    
                    <div class="drop-area disabled" id="cv-drop">
                        <i class="fas fa-file-video"></i>
                        <h3>Drop video file here</h3>
                        <p>or click to browse</p>
                        <input type="file" id="cv-file" style="display: none" accept="video/*">
                    </div>
                    
                    <div class="file-info hidden" id="cv-file-info">
                        <i class="fas fa-file-video"></i>
                        <div class="file-name" id="cv-file-name"></div>
                        <div class="remove-file" id="cv-remove">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="fps">Frames Per Second (FPS)</label>
                        <input type="number" id="fps" min="0.1" max="10" step="0.1" value="1.0">
                        <small>Lower values for better accuracy</small>
                    </div>
                    
                    <button class="btn" id="cv-upload-btn" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> Upload & Analyze
                    </button>
                    
                    <div class="progress-container hidden" id="cv-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="cv-progress-fill"></div>
                        </div>
                        <div class="progress-info">
                            <span id="cv-progress-text">Processing...</span>
                            <span id="cv-progress-percent">0%</span>
                        </div>
                    </div>
                </div>

                <div class="card upload-section" id="gpt-upload" style="display: none;">
                    <div class="card-title">
                        <i class="fas fa-image"></i> Upload Chart
                    </div>
                    
                    <div class="drop-area" id="gpt-drop">
                        <i class="fas fa-file-image"></i>
                        <h3>Drop chart image here</h3>
                        <p>or click to browse</p>
                        <input type="file" id="gpt-file" style="display: none" accept="image/*">
                    </div>
                    
                    <div class="file-info hidden" id="gpt-file-info">
                        <i class="fas fa-file-image"></i>
                        <div class="file-name" id="gpt-file-name"></div>
                        <div class="remove-file" id="gpt-remove">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    
                    <button class="btn" id="gpt-upload-btn" disabled>
                        <i class="fas fa-magic"></i> Analyze with GPT
                    </button>
                    
                    <div class="progress-container hidden" id="gpt-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="gpt-progress-fill"></div>
                        </div>
                        <div class="progress-info">
                            <span id="gpt-progress-text">Processing...</span>
                            <span id="gpt-progress-percent">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-history"></i> Recent Jobs
                        <button id="refresh-jobs" style="background: none; border: none; cursor: pointer; color: var(--primary); margin-left: auto;">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <ul class="jobs-list" id="jobs-list"></ul>
                </div>
            </div>
            
            <div class="results-area" id="results-area">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-chart-bar"></i> Analysis Results
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="cv-results">Computer Vision</div>
                        <div class="tab" data-tab="gpt-results">GPT Vision</div>
                    </div>
                    
                    <div class="tab-content active" id="cv-results">
                        <div class="frames-grid" id="frames-grid"></div>
                        <div class="hidden" id="frame-details">
                            <h3 style="margin: 30px 0 20px 0; color: var(--primary);">Frame Details</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div class="card">
                                    <h4>Original Frame</h4>
                                    <img id="detail-frame" style="width: 100%; border-radius: 8px; cursor: pointer;">
                                </div>
                                <div class="card">
                                    <h4>Chart Overlay</h4>
                                    <img id="detail-overlay" style="width: 100%; border-radius: 8px; cursor: pointer;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="gpt-results">
                        <div id="gpt-matches"></div>
                        <div id="gpt-all-results"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Chart Analysis System - JavaScript Loading...');
        
        const API_BASE = "http://209.38.230.201:5000";
        console.log('API Base URL:', API_BASE);
        
        let state = {
            method: null,
            category: null,
            file: null,
            jobId: null,
            status: { 
                computer_vision_available: false, 
                gpt_vision_available: false, 
                count: 0 
            },
            isProcessing: false,
            websocket: null,
            pollingInterval: null
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM Content Loaded - Initializing...');
            
            // Setup events first
            setupEvents();
            
            // Initialize WebSocket connection
            initializeWebSocket();
            
            // Load system status with retry
            setTimeout(() => {
                loadSystemStatus();
            }, 100);
            
            // Load jobs
            setTimeout(() => {
                loadJobs();
            }, 200);
        });

        // Initialize WebSocket for GPT Vision progress
        function initializeWebSocket() {
            console.log('üîå Initializing WebSocket connection...');
            
            try {
                const wsUrl = `ws://localhost:5000/ws`;
                state.websocket = new WebSocket(wsUrl);
                
                state.websocket.onopen = function(event) {
                    console.log('‚úÖ WebSocket connected');
                };
                
                state.websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('üì® WebSocket message received:', data);
                        
                        if (data.type === 'progress') {
                            updateGPTProgress(data.percentage, data.message, data.completed_comparisons);
                        }
                    } catch (error) {
                        console.error('‚ùå WebSocket message parse error:', error);
                    }
                };
                
                state.websocket.onclose = function(event) {
                    console.log('üîå WebSocket disconnected');
                    // Attempt to reconnect after 3 seconds
                    setTimeout(() => {
                        if (!state.websocket || state.websocket.readyState === WebSocket.CLOSED) {
                            console.log('üîÑ Attempting to reconnect WebSocket...');
                            initializeWebSocket();
                        }
                    }, 3000);
                };
                
                state.websocket.onerror = function(error) {
                    console.error('‚ùå WebSocket error:', error);
                };
                
            } catch (error) {
                console.error('‚ùå WebSocket initialization error:', error);
            }
        }

        // Update GPT Vision progress
        function updateGPTProgress(percentage, message, completed) {
            console.log('üìä Updating GPT Progress:', percentage, message, completed);
            
            const progressFill = document.getElementById('gpt-progress-fill');
            const progressText = document.getElementById('gpt-progress-text');
            const progressPercent = document.getElementById('gpt-progress-percent');
            
            if (progressFill) {
                progressFill.style.width = `${percentage}%`;
            }
            
            if (progressText) {
                progressText.textContent = message || 'Processing...';
            }
            
            if (progressPercent) {
                progressPercent.textContent = `${percentage}%`;
            }
            
            // Show completed comparisons if available
            if (completed !== undefined && completed !== null) {
                const progressText = document.getElementById('gpt-progress-text');
                if (progressText) {
                    progressText.textContent = `${message} (${completed} completed)`;
                }
            }
        }

        // Enhanced system status loading with better error handling
        async function loadSystemStatus() {
            console.log('üîç Loading system status...');
            
            try {
                const url = `${API_BASE}/api/system-status`;
                console.log('üì° Fetching from:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-cache'
                });
                
                console.log('üì• Response status:', response.status, response.ok);
                
                if (response.ok) {
                    const status = await response.json();
                    console.log('‚úÖ Status data received:', status);
                    
                    // Update global state
                    state.status = {
                        computer_vision_available: status.computer_vision_available,
                        gpt_vision_available: status.gpt_vision_available,
                        count: status.historical_charts_count
                    };
                    
                    console.log('üíæ Updated state.status:', state.status);
                    
                    // Update UI elements
                    updateStatusIndicators(status);
                    updateMethodAvailability(status);
                    
                    console.log('üéâ System status loaded successfully!');
                    
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error loading system status:', error);
                showAlert('Cannot connect to API server. Please check if the server is running.', 'error');
                
                // Set default offline state
                updateStatusIndicators({
                    computer_vision_available: false,
                    gpt_vision_available: false,
                    historical_charts_count: 0
                });
            }
        }

        function updateStatusIndicators(status) {
            console.log('üé® Updating status indicators with:', status);
            
            const cvStatus = document.getElementById('cv-status');
            const gptStatus = document.getElementById('gpt-status');
            const historicalCount = document.getElementById('historical-count');
            
            if (cvStatus) {
                cvStatus.className = status.computer_vision_available ? 'status-dot available' : 'status-dot';
                console.log('üîµ CV Status dot class:', cvStatus.className);
            } else {
                console.warn('‚ö†Ô∏è CV status element not found');
            }
            
            if (gptStatus) {
                gptStatus.className = status.gpt_vision_available ? 'status-dot available' : 'status-dot';
                console.log('üü¢ GPT Status dot class:', gptStatus.className);
            } else {
                console.warn('‚ö†Ô∏è GPT status element not found');
            }
            
            if (historicalCount) {
                historicalCount.textContent = `${status.historical_charts_count} Historical Charts`;
                console.log('üìä Historical count updated:', historicalCount.textContent);
            } else {
                console.warn('‚ö†Ô∏è Historical count element not found');
            }
        }

        function updateMethodAvailability(status) {
            console.log('üõ†Ô∏è Updating method availability with:', status);
            
            const cvMethod = document.getElementById('cv-method');
            const gptMethod = document.getElementById('gpt-method');
            
            if (cvMethod) {
                if (!status.computer_vision_available) {
                    cvMethod.classList.add('disabled');
                    cvMethod.title = 'Computer Vision not available';
                    console.log('üî¥ CV Method disabled');
                } else {
                    cvMethod.classList.remove('disabled');
                    cvMethod.title = '';
                    console.log('üü¢ CV Method enabled');
                }
            }
            
            if (gptMethod) {
                if (!status.gpt_vision_available) {
                    gptMethod.classList.add('disabled');
                    gptMethod.title = 'GPT Vision not available';
                    console.log('üî¥ GPT Method disabled');
                } else {
                    gptMethod.classList.remove('disabled');
                    gptMethod.title = '';
                    console.log('üü¢ GPT Method enabled');
                }
            }
        }

        // Enhanced event setup
        function setupEvents() {
            console.log('üîó Setting up event listeners...');
            
            try {
                // Method selection
                document.querySelectorAll('.method-option').forEach(el => {
                    el.addEventListener('click', () => {
                        console.log('üéØ Method clicked:', el.dataset.method);
                        selectMethod(el.dataset.method);
                    });
                });

                // Category selection
                document.querySelectorAll('.category-option').forEach(el => {
                    el.addEventListener('click', () => {
                        console.log('üìÇ Category clicked:', el.dataset.category);
                        selectCategory(el.dataset.category);
                    });
                });

                // File handling
                setupFileHandling('cv');
                setupFileHandling('gpt');

                // Buttons
                const cvUploadBtn = document.getElementById('cv-upload-btn');
                const gptUploadBtn = document.getElementById('gpt-upload-btn');
                const refreshJobsBtn = document.getElementById('refresh-jobs');

                if (cvUploadBtn) cvUploadBtn.addEventListener('click', () => uploadFile('cv'));
                if (gptUploadBtn) gptUploadBtn.addEventListener('click', () => uploadFile('gpt'));
                if (refreshJobsBtn) refreshJobsBtn.addEventListener('click', loadJobs);

                // Tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
                });

                // Modal
                const modal = document.getElementById('imageModal');
                const closeBtn = document.querySelector('.close');
                
                if (closeBtn) closeBtn.onclick = () => modal.style.display = 'none';
                if (modal) modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

                console.log('‚úÖ Event listeners setup complete');
                
            } catch (error) {
                console.error('‚ùå Error setting up events:', error);
            }
        }

        // Method selection with enhanced logging
        function selectMethod(method) {
            console.log('üéØ Selecting method:', method);
            console.log('üìä Current state.status:', state.status);
            
            // Prevent method changes during processing
            if (state.isProcessing) {
                console.log('‚ö†Ô∏è Cannot change method during processing');
                showAlert('Please wait for current analysis to complete.', 'warning');
                return;
            }
            
            // Check if method is available
            if (method === 'computer_vision' && !state.status.computer_vision_available) {
                console.log('üö´ Computer Vision not available');
                showAlert('Computer Vision analysis is not available.', 'error');
                return;
            }
            
            if (method === 'gpt_vision' && !state.status.gpt_vision_available) {
                console.log('üö´ GPT Vision not available');
                showAlert('GPT Vision analysis is not available.', 'error');
                return;
            }

            state.method = method;
            console.log('‚úÖ Method selected:', method);
            
            // Update UI
            document.querySelectorAll('.method-option').forEach(el => el.classList.remove('selected'));
            const selectedElement = document.getElementById(`${method === 'computer_vision' ? 'cv' : 'gpt'}-method`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
                console.log('üé® Updated selected method UI');
            }
            
            // Show appropriate upload section
            document.querySelectorAll('.upload-section').forEach(el => el.style.display = 'none');
            const uploadSection = document.getElementById(`${method === 'computer_vision' ? 'cv' : 'gpt'}-upload`);
            if (uploadSection) {
                uploadSection.style.display = 'block';
                console.log('üì§ Showing upload section for:', method);
            }
            
            resetFile();
            hideResults();
        }

        // Category selection
        function selectCategory(category) {
            console.log('üìÇ Selecting category:', category);
            
            if (state.method !== 'computer_vision') {
                console.log('‚ö†Ô∏è Category selection only for computer vision');
                return;
            }
            
            if (state.isProcessing) {
                console.log('‚ö†Ô∏è Cannot change category during processing');
                showAlert('Please wait for current analysis to complete.', 'warning');
                return;
            }
            
            state.category = category;
            
            document.querySelectorAll('.category-option').forEach(el => el.classList.remove('selected'));
            const selectedCat = document.querySelector(`[data-category="${category}"]`);
            if (selectedCat) {
                selectedCat.classList.add('selected');
                console.log('‚úÖ Category selected UI updated');
            }
            
            const cvDrop = document.getElementById('cv-drop');
            if (cvDrop) {
                cvDrop.classList.remove('disabled');
                console.log('üì§ CV drop area enabled');
            }
        }

        // File handling setup
        function setupFileHandling(type) {
            console.log('üìÅ Setting up file handling for:', type);
            
            const drop = document.getElementById(`${type}-drop`);
            const input = document.getElementById(`${type}-file`);
            const info = document.getElementById(`${type}-file-info`);
            const name = document.getElementById(`${type}-file-name`);
            const remove = document.getElementById(`${type}-remove`);
            
            if (!drop || !input) {
                console.warn(`‚ö†Ô∏è File handling elements not found for ${type}`);
                return;
            }
            
            drop.addEventListener('click', () => {
                if (!drop.classList.contains('disabled') && !state.isProcessing) {
                    input.click();
                }
            });
            
            drop.addEventListener('dragover', (e) => { 
                e.preventDefault();
                if (!state.isProcessing) {
                    drop.classList.add('active');
                }
            });
            
            drop.addEventListener('dragleave', (e) => { 
                e.preventDefault(); 
                drop.classList.remove('active'); 
            });
            
            drop.addEventListener('drop', (e) => {
                e.preventDefault();
                drop.classList.remove('active');
                if (!state.isProcessing && e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0], type);
                }
            });
            
            input.addEventListener('change', (e) => {
                if (!state.isProcessing && e.target.files.length) {
                    handleFile(e.target.files[0], type);
                }
            });
            
            if (remove) {
                remove.addEventListener('click', () => {
                    if (!state.isProcessing) {
                        resetFile(type);
                    }
                });
            }
        }

        function handleFile(file, type) {
            console.log('üìÅ Handling file:', file.name, 'for type:', type);
            
            if (state.isProcessing) {
                console.log('‚ö†Ô∏è Cannot handle file during processing');
                showAlert('Please wait for current analysis to complete.', 'warning');
                return;
            }
            
            if (type === 'cv') {
                if (!file.type.startsWith('video/')) {
                    showAlert('Please select a video file.', 'error');
                    return;
                }
                if (!state.category) {
                    showAlert('Please select a category first.', 'warning');
                    return;
                }
            } else if (!file.type.startsWith('image/')) {
                showAlert('Please select an image file.', 'error');
                return;
            }
            
            state.file = file;
            
            const fileName = document.getElementById(`${type}-file-name`);
            const fileInfo = document.getElementById(`${type}-file-info`);
            const uploadBtn = document.getElementById(`${type}-upload-btn`);
            
            if (fileName) fileName.textContent = file.name;
            if (fileInfo) fileInfo.classList.remove('hidden');
            if (uploadBtn) uploadBtn.disabled = false;
            
            console.log('‚úÖ File handled successfully');
        }

        function resetFile(type) {
            console.log('üóëÔ∏è Resetting file for type:', type);
            
            if (state.isProcessing) {
                console.log('‚ö†Ô∏è Cannot reset file during processing');
                return;
            }
            
            state.file = null;
            
            if (!type || type === 'cv') {
                const elements = ['cv-file-name', 'cv-file-info', 'cv-file', 'cv-upload-btn'];
                elements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id.includes('name')) el.textContent = '';
                        else if (id.includes('info')) el.classList.add('hidden');
                        else if (id.includes('file') && !id.includes('name')) el.value = '';
                        else if (id.includes('btn')) el.disabled = true;
                    }
                });
            }
            
            if (!type || type === 'gpt') {
                const elements = ['gpt-file-name', 'gpt-file-info', 'gpt-file', 'gpt-upload-btn'];
                elements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id.includes('name')) el.textContent = '';
                        else if (id.includes('info')) el.classList.add('hidden');
                        else if (id.includes('file') && !id.includes('name')) el.value = '';
                        else if (id.includes('btn')) el.disabled = true;
                    }
                });
            }
        }

        // Upload and analyze with proper processing state management
        async function uploadFile(type) {
            console.log('‚¨ÜÔ∏è Uploading file for type:', type);
            
            if (!state.file) {
                showAlert('Please select a file first.', 'warning');
                return;
            }

            if (state.isProcessing) {
                console.log('‚ö†Ô∏è Already processing, ignoring upload request');
                showAlert('Analysis already in progress. Please wait.', 'warning');
                return;
            }

            // Set processing state
            state.isProcessing = true;
            
            const btn = document.getElementById(`${type}-upload-btn`);
            const progress = document.getElementById(`${type}-progress`);
            
            // Update button state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div> Processing...';
                btn.style.opacity = '0.7';
            }
            
            // Show progress
            if (progress) {
                progress.classList.remove('hidden');
                // Reset progress
                const progressFill = document.getElementById(`${type}-progress-fill`);
                const progressText = document.getElementById(`${type}-progress-text`);
                const progressPercent = document.getElementById(`${type}-progress-percent`);
                
                if (progressFill) progressFill.style.width = '0%';
                if (progressText) progressText.textContent = 'Starting...';
                if (progressPercent) progressPercent.textContent = '0%';
            }
            
            // Disable UI elements during processing
            disableUI();
            
            try {
                if (type === 'cv') {
                    await uploadCV();
                } else {
                    await uploadGPT();
                }
            } catch (error) {
                console.error('‚ùå Upload failed:', error);
                showAlert(`Failed to analyze: ${error.message}`, 'error');
                
                // Reset processing state
                state.isProcessing = false;
                
                // Hide progress
                if (progress) progress.classList.add('hidden');
                
                // Re-enable UI
                enableUI();
                
                // Reset button
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = type === 'cv' ? 
                        '<i class="fas fa-cloud-upload-alt"></i> Upload & Analyze' : 
                        '<i class="fas fa-magic"></i> Analyze with GPT';
                    btn.style.opacity = '1';
                }
            }
        }

        // Disable UI elements during processing
        function disableUI() {
            console.log('üîí Disabling UI during processing');
            
            // Disable method selection
            document.querySelectorAll('.method-option').forEach(el => {
                el.style.pointerEvents = 'none';
                el.style.opacity = '0.6';
            });
            
            // Disable category selection
            document.querySelectorAll('.category-option').forEach(el => {
                el.style.pointerEvents = 'none';
                el.style.opacity = '0.6';
            });
            
            // Disable file operations
            document.querySelectorAll('.drop-area').forEach(el => {
                el.classList.add('disabled');
            });
            
            // Disable FPS input
            const fpsInput = document.getElementById('fps');
            if (fpsInput) fpsInput.disabled = true;
        }

        // Re-enable UI elements after processing
        function enableUI() {
            console.log('üîì Re-enabling UI after processing');
            
            // Enable method selection
            document.querySelectorAll('.method-option').forEach(el => {
                el.style.pointerEvents = 'auto';
                el.style.opacity = '1';
            });
            
            // Enable category selection
            document.querySelectorAll('.category-option').forEach(el => {
                el.style.pointerEvents = 'auto';
                el.style.opacity = '1';
            });
            
            // Enable file operations
            document.querySelectorAll('.drop-area').forEach(el => {
                if (state.category || state.method === 'gpt_vision') {
                    el.classList.remove('disabled');
                }
            });
            
            // Enable FPS input
            const fpsInput = document.getElementById('fps');
            if (fpsInput) fpsInput.disabled = false;
        }

        // Enhanced uploadCV function with proper state management
        async function uploadCV() {
            console.log('üé• Starting CV upload...');
            
            const formData = new FormData();
            formData.append('file', state.file);
            formData.append('category', state.category);
            formData.append('analysis_type', 'computer_vision');
            
            const response = await fetch(`${API_BASE}/api/upload`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) throw new Error('Upload failed');
            
            const data = await response.json();
            state.jobId = data.job_id;
            console.log('‚úÖ CV upload successful, job ID:', state.jobId);
            
            // Start analysis
            const fps = parseFloat(document.getElementById('fps').value) || 1.0;
            const analyzeResponse = await fetch(`${API_BASE}/api/analyze/${state.jobId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fps: fps,
                    category: state.category,
                    analysis_type: 'computer_vision'
                })
            });
            
            if (!analyzeResponse.ok) throw new Error('Analysis failed');
            
            startPolling();
        }

        // Enhanced uploadGPT function with proper state management
        async function uploadGPT() {
            console.log('üß† Starting GPT upload...');
            
            const formData = new FormData();
            formData.append('file', state.file);
            
            const response = await fetch(`${API_BASE}/api/gpt-compare`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) throw new Error('Analysis failed');
            
            const data = await response.json();
            console.log('‚úÖ GPT analysis complete');
            
            // The progress is now handled by WebSocket, so we just wait and display results
            setTimeout(() => {
                const progressEl = document.getElementById('gpt-progress');
                if (progressEl) progressEl.classList.add('hidden');
                
                // Reset processing state
                state.isProcessing = false;
                
                // Re-enable UI
                enableUI();
                
                // Reset button
                const btn = document.getElementById('gpt-upload-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-magic"></i> Analyze with GPT';
                    btn.style.opacity = '1';
                }
                
                displayGPTResults(data);
                loadJobs();
            }, 2000);
        }

        // Enhanced polling for CV results with proper state management
        function startPolling() {
            console.log('üîÑ Starting polling for job:', state.jobId);
            
            // Clear any existing polling interval
            if (state.pollingInterval) {
                clearInterval(state.pollingInterval);
            }
            
            state.pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/job/${state.jobId}`);
                    if (!response.ok) throw new Error('Failed to get job status');
                    
                    const data = await response.json();
                    const progress = data.progress || 0;
                    
                    const progressFill = document.getElementById('cv-progress-fill');
                    const progressPercent = document.getElementById('cv-progress-percent');
                    const progressText = document.getElementById('cv-progress-text');
                    
                    if (progressFill) progressFill.style.width = `${progress}%`;
                    if (progressPercent) progressPercent.textContent = `${progress}%`;
                    if (progressText) progressText.textContent = `Processing... ${progress}%`;
                    
                    if (data.status === 'completed') {
                        clearInterval(state.pollingInterval);
                        state.pollingInterval = null;
                        
                        // Hide progress
                        const progressContainer = document.getElementById('cv-progress');
                        if (progressContainer) progressContainer.classList.add('hidden');
                        
                        // Reset processing state
                        state.isProcessing = false;
                        
                        // Re-enable UI
                        enableUI();
                        
                        // Reset button
                        const uploadBtn = document.getElementById('cv-upload-btn');
                        if (uploadBtn) {
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload & Analyze';
                            uploadBtn.style.opacity = '1';
                        }
                        
                        displayCVResults(data.results);
                        loadJobs();
                        console.log('‚úÖ CV analysis completed');
                        
                    } else if (data.status === 'failed') {
                        clearInterval(state.pollingInterval);
                        state.pollingInterval = null;
                        
                        // Hide progress
                        const progressContainer = document.getElementById('cv-progress');
                        if (progressContainer) progressContainer.classList.add('hidden');
                        
                        // Reset processing state
                        state.isProcessing = false;
                        
                        // Re-enable UI
                        enableUI();
                        
                        // Reset button
                        const uploadBtn = document.getElementById('cv-upload-btn');
                        if (uploadBtn) {
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload & Analyze';
                            uploadBtn.style.opacity = '1';
                        }
                        
                        showAlert(`Analysis failed: ${data.error || 'Unknown error'}`, 'error');
                        console.error('‚ùå CV analysis failed:', data.error);
                    }
                } catch (error) {
                    console.error('‚ùå Polling error:', error);
                    
                    // If polling fails multiple times, reset state
                    if (state.pollingInterval) {
                        clearInterval(state.pollingInterval);
                        state.pollingInterval = null;
                        state.isProcessing = false;
                        enableUI();
                        
                        const uploadBtn = document.getElementById('cv-upload-btn');
                        if (uploadBtn) {
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload & Analyze';
                            uploadBtn.style.opacity = '1';
                        }
                        
                        showAlert('Connection error. Please try again.', 'error');
                    }
                }
            }, 1000);
        }

        // Display results functions
        function displayCVResults(results) {
            console.log('üìä Displaying CV results:', results);
            
            if (!results?.top_frames?.length) {
                showAlert('No similar frames found.', 'warning');
                return;
            }
            
            showResults();
            switchTab('cv-results');
            
            const grid = document.getElementById('frames-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            const sorted = [...results.top_frames].sort((a, b) => b.similarity - a.similarity);
            
            sorted.forEach((frame, index) => {
                const similarity = frame.similarity;
                let badgeClass = 'low-similarity';
                if (similarity > 0.8) badgeClass = 'high-similarity';
                else if (similarity > 0.5) badgeClass = 'medium-similarity';
                
                const card = document.createElement('div');
                card.className = 'frame-card';
                card.innerHTML = `
                    <img class="frame-img" src="${API_BASE}/results/${frame.frame_path.replace('results/', '')}" alt="Frame">
                    <div class="frame-info">
                        <div class="frame-time">Time: ${frame.time.toFixed(2)}s</div>
                        <div class="similarity-score">
                            Similarity: ${similarity.toFixed(4)}
                            <span class="similarity-badge ${badgeClass}">${(similarity * 100).toFixed(0)}%</span>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    document.querySelectorAll('.frame-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    showFrameDetails(frame);
                });
                
                grid.appendChild(card);
                
                if (index === 0) {
                    setTimeout(() => card.click(), 100);
                }
            });
        }

        function showFrameDetails(frame) {
            const details = document.getElementById('frame-details');
            const frameNum = frame.frame_number.toString().padStart(6, '0');
            const prefix = `${API_BASE}/results/${state.jobId}`;
            
            const detailFrame = document.getElementById('detail-frame');
            const detailOverlay = document.getElementById('detail-overlay');
            
            if (detailFrame) {
                detailFrame.src = `${prefix}/frame_${frameNum}.jpg`;
                detailFrame.onclick = () => openModal(`${prefix}/frame_${frameNum}.jpg`);
            }
            
            if (detailOverlay) {
                detailOverlay.src = `${prefix}/overlay_${frameNum}.png`;
                detailOverlay.onclick = () => openModal(`${prefix}/overlay_${frameNum}.png`);
            }
            
            if (details) {
                details.classList.remove('hidden');
                details.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function displayGPTResults(data) {
            console.log('üß† Displaying GPT results:', data);
            
            showResults();
            switchTab('gpt-results');
            
            const matches = document.getElementById('gpt-matches');
            const allResults = document.getElementById('gpt-all-results');
            
            if (matches) {
                matches.innerHTML = '<h3>Top Matches</h3>';
                data.top_matches.forEach((match, index) => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; justify-content: space-between; padding: 15px; margin: 10px 0; background: white; border-radius: 8px; box-shadow: var(--shadow);';
                    div.innerHTML = `
                        <span style="font-weight: bold; color: var(--primary);">#${index + 1} - Year ${match.year}</span>
                        <span style="font-weight: bold; color: var(--secondary);">${match.score}/100</span>
                    `;
                    matches.appendChild(div);
                });
            }
            
            if (allResults) {
                allResults.innerHTML = '<h3>All Results</h3>';
                data.results.forEach(result => {
                    const div = document.createElement('div');
                    div.style.cssText = 'padding: 20px; border-bottom: 1px solid var(--border);';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span style="font-weight: bold;">Year ${result.year}</span>
                            <span style="font-weight: bold;">${result.score}/100</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                            <div style="text-align: center;">
                                <h4>Current (2025)</h4>
                                <img src="${data.current_image_url}" style="width: 100%; border-radius: 8px; cursor: pointer;" onclick="openModal('${data.current_image_url}')">
                            </div>
                            <div style="text-align: center;">
                                <h4>Historical (${result.year})</h4>
                                <img src="${result.historical_image_url}" style="width: 100%; border-radius: 8px; cursor: pointer;" onclick="openModal('${result.historical_image_url}')">
                            </div>
                        </div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);">
                            ${result.analysis}
                        </div>
                    `;
                    allResults.appendChild(div);
                });
            }
        }

        // Jobs management
        async function loadJobs() {
            console.log('üíº Loading jobs...');
            
            try {
                const response = await fetch(`${API_BASE}/api/jobs`);
                if (!response.ok) throw new Error('Failed to load jobs');
                
                const data = await response.json();
                const list = document.getElementById('jobs-list');
                
                if (!list) return;
                
                list.innerHTML = '';
                
                if (data.jobs?.length) {
                    data.jobs.forEach(job => {
                        const li = document.createElement('li');
                        li.className = 'job-item';
                        if (job.id === state.jobId) li.classList.add('active');
                        
                        const statusIcons = {
                            uploaded: 'fas fa-file-upload',
                            processing: 'fas fa-spinner fa-spin',
                            completed: 'fas fa-check-circle',
                            failed: 'fas fa-exclamation-circle'
                        };
                        
                        li.innerHTML = `
                            <i class="${statusIcons[job.status] || 'fas fa-question-circle'}"></i>
                            <div class="job-info">
                                <div class="job-filename">${job.filename}</div>
                                <div class="job-time">${formatTime(job.created_at)} ‚Ä¢ ${job.analysis_type === 'gpt_vision' ? 'GPT' : 'CV'}</div>
                            </div>
                            <div class="job-actions">
                                <button class="delete" onclick="deleteJob('${job.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        
                        li.addEventListener('click', (e) => {
                            if (!e.target.closest('.delete')) loadJob(job.id);
                        });
                        
                        list.appendChild(li);
                    });
                } else {
                    list.innerHTML = '<li style="padding: 15px; text-align: center; color: var(--muted);">No jobs found</li>';
                }
                
                console.log('‚úÖ Jobs loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Jobs loading error:', error);
            }
        }

        async function loadJob(jobId) {
            console.log('üìã Loading job:', jobId);
            
            try {
                const response = await fetch(`${API_BASE}/api/job/${jobId}`);
                if (!response.ok) throw new Error('Failed to load job');
                
                const data = await response.json();
                state.jobId = jobId;
                
                if (data.analysis_type) {
                    selectMethod(data.analysis_type);
                }
                
                if (data.status === 'completed' && data.results) {
                    if (data.analysis_type === 'gpt_vision') {
                        displayGPTResults(data.results);
                    } else {
                        displayCVResults(data.results);
                    }
                }
                
                // Update active job UI
                document.querySelectorAll('.job-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector(`[onclick*="${jobId}"]`)) {
                        item.classList.add('active');
                    }
                });
                
                console.log('‚úÖ Job loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Load job error:', error);
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('Delete this job?')) return;
            
            console.log('üóëÔ∏è Deleting job:', jobId);
            
            try {
                const response = await fetch(`${API_BASE}/api/job/${jobId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete job');
                
                loadJobs();
                if (jobId === state.jobId) {
                    state.jobId = null;
                    resetFile();
                    hideResults();
                }
                
                showAlert('Job deleted successfully.', 'success');
                console.log('‚úÖ Job deleted successfully');
                
            } catch (error) {
                console.error('‚ùå Delete job error:', error);
                showAlert(`Failed to delete job: ${error.message}`, 'error');
            }
        }

        // UI utilities
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tab = document.querySelector(`[data-tab="${tabId}"]`);
            const content = document.getElementById(tabId);
            
            if (tab) tab.classList.add('active');
            if (content) content.classList.add('active');
        }

        function showResults() {
            const resultsArea = document.getElementById('results-area');
            if (resultsArea) resultsArea.style.display = 'block';
        }

        function hideResults() {
            const resultsArea = document.getElementById('results-area');
            if (resultsArea) resultsArea.style.display = 'none';
        }

        function openModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            if (modal && modalImage) {
                modalImage.src = src;
                modal.style.display = 'block';
            }
        }

        function showAlert(message, type = 'success') {
            console.log(`üîî Alert (${type}):`, message);
            
            // Remove existing alert
            const existing = document.querySelector('.alert');
            if (existing) existing.remove();
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle'
            };
            
            alert.innerHTML = `<i class="${icons[type]}"></i> ${message}`;
            
            const mainGrid = document.querySelector('.main-grid');
            if (mainGrid) {
                mainGrid.insertAdjacentElement('beforebegin', alert);
                setTimeout(() => alert.remove(), 5000);
            }
        }

        function formatTime(timestamp) {
            const diff = Date.now() - timestamp * 1000;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'just now';
        }

        // Global functions for onclick handlers
        window.openModal = openModal;
        window.deleteJob = deleteJob;
        window.loadSystemStatus = loadSystemStatus; // For debugging

        console.log('‚úÖ Chart Analysis System JavaScript Loaded Successfully!');
    </script>
</body>
</html>